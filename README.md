# SillyTavern 声临其境 (Immersive Sound)

**作者:** 从前跟你一样
**版本:** 2.0.0

这是一个为 [SillyTavern](https://github.com/SillyTavern/SillyTavern) 设计的第三方扩展，旨在通过 AI 驱动的背景音乐（BGM）、环境音（Ambiance）、音效（SFX）和语音合成（TTS），为用户的阅读体验带来真正的“声临其境”。

当用户双击一条消息时，此插件不仅能像卡拉OK一样逐字高亮文本，还能将消息内容发送给大语言模型（LLM）进行分析，并自动生成一套完整的、与故事情节同步的音频播放方案。

## ✨ 核心功能

-   **AI 自动生成音频方案**:
    -   **双击分析**: 双击任意消息，插件会自动调用 LLM 分析文本，并生成匹配故事情节的背景音乐、环境音、音效和角色语音。
    -   **无需手动配置**: 对于普通用户，不再需要在角色卡中手动编写复杂的音频标签。

-   **沉浸式空间音效**:
    -   **同步音频播放**:
        -   **背景音乐 (Music)**: 在指定段落之间循环播放音乐。
        -   **环境音 (Ambiance)**: 用于持续的环境声音，如雨声、森林声。
        -   **音效 (SFX/SFX_WAIT)**: 在读到特定词语时触发一次性或延迟音效。
        -   **语音合成 (VOICE)**: 将角色的对话文本通过 TTS 合成为语音，并从其所在位置发出。
    -   **3D 空间定位**: 所有类型的音频都支持空间定位（左/右/远/近）和环境混响（如教堂、山洞），创造出真实的声场。

-   **高度可定制**:
    -   **逐字高亮**: 模仿卡拉OK字幕效果，高亮正在“朗读”的文本，并支持从点击处开始阅读。
    -   **精细的音频控制**: 为每种音频类型（音乐、环境、音效、语音）提供独立的音量、淡入/淡出控制。
    -   **LLM 和 TTS 配置**: 支持自定义 LLM API 和 Prompt，支持接入多种 TTS 服务并管理音色库。
    -   **智能缓存系统**: 自动缓存 LLM 分析结果和 TTS 生成的音频，提升响应速度并节省资源。
    -   **快速清空缓存**: 快速连续双击消息可立即清空缓存，强制 AI 重新分析。
    -   **移动端震动反馈**: 在播放特定音效时，可在移动设备上触发震动。

## 🚀 安装

1.  在 SillyTavern 中通过 `第三方扩展 -> 下载扩展` 安装 `https://github.com/damoshen123/st-immersive-sound`。
2.  重启 SillyTavern。
3.  在 `扩展` 菜单中启用 "st-immersive-sound"。

## 📖 使用方法

插件提供两种模式：**自动模式 (AI 驱动)** 和 **手动模式 (高级)**。

### 模式一：自动模式 (AI 驱动) - 推荐

这是最简单且功能最强大的使用方式。

**第一步：配置 LLM 和 TTS**

1.  点击右上角菜单中的“打开声临其境设置”按钮。
2.  切换到 **LLM 设置** 标签页。
    -   填入你的大语言模型 API 的 `Endpoint` 和 `API Key`。
    -   （可选）根据你的模型能力，调整 `Prompt` 以获得更好的分析效果。
3.  切换到 **TTS 设置** 标签页。
    -   配置你的 TTS 服务（如 Fish-Audio）。
    -   添加并管理你希望角色使用的不同音色（Speaker）。
4.  （可选）在 **音频资源** 标签页中，通过世界信息添加你自己的音乐和音效库，AI 会在分析时优先使用它们。

**第二步：双击消息**

-   在聊天界面，**双击任意一条你希望添加音频的消息**。
-   插件会短暂显示“正在处理...”，此时它正在将文本发送给 LLM。
-   处理完成后，再次双击该消息，即可开始播放由 AI 为你量身定制的、包含背景音乐、环境音、音效和角色语音的沉浸式内容！

> **小技巧**: 如果你对 AI 生成的效果不满意，**快速连续双击** 同一条消息，插件会清空缓存，让你可以重新触发 AI 分析。

### 模式二：手动模式 (高级)


**2. 插入音频标签**

在角色卡或聊天消息中，插入 XML 格式的标签来指定音频。

#### 标签类型

-   `<Music>` / `<Ambiance>`: 背景音乐/环境音。
-   `<SFX>` / `<SFX_WAIT>`: 普通/延迟音效。
-   `<VOICE>`: **(新)** 角色语音合成。

#### 参数说明

-   `src`: **(必需)** 音频的 `key`，对应你在世界信息中配置的名字。
-   `loop`: `true` (循环) / `false` (单次)。
-   `regex_start` / `regex_end`: **(循环音频)** 标记播放区间的正则表达式。
-   `regex`: **(非循环音频)** 触发音效的正则表达式。
-   `spatial`: **(所有类型)** 空间定位。预设值如 `正前方站立`, `左侧`, `右上方`, `路过（左→右）` 等。
-   `ir_description`: **(所有类型)** 环境混响。预设值如 `户外`, `大房间`, `教堂`, `山洞` 等。

#### `<VOICE>` 标签详解

`<VOICE>` 标签用于将文本合成为语音。

**结构:**
```xml
<VOICE>
  [speaker=音色名, context_texts=语气描述, loop=false, spatial=空间定位, ir_description=环境混响, regex=/^要合成的对话文本$/]
</VOICE>
```

-   `speaker`: **(必需)** 在 **TTS 设置** 中配置的音色名称。
-   `context_texts`: **(推荐)** 给 TTS 模型的语气提示，如“低声地、带着恐惧说”、“开心地大喊”等，能极大提升语音的情感表现力。
-   `regex`: **(必需)** 需要被合成为语音的精确文本。

## ⚙️ 设置选项

插件提供了丰富的设置项，分布在不同的标签页中：

-   **常规设置**: 插件总开关、阅读速度 (CPM)、高亮颜色/透明度等。
-   **LLM 设置**: **(核心)** 配置 LLM 的 API Key, Endpoint, Prompt，以及测试模式。
-   **TTS 设置**: **(核心)** 配置 TTS 服务，管理和试听音色库。
-   **音量设置**: 分别调整主音量、音乐、环境、音效和语音的音量、淡入/淡出时间。
-   **空间音效**: 为不同类型的音频开启/关闭 3D 效果，并调整详细的 3D 空间参数。
-   **音频资源**: 管理通过世界信息加载的音频文件。
-   **缓存管理**: 查看和清理已缓存的 LLM 结果和 TTS 音频。
-   **其他**: 包括界面主题、震动效果、日志等高级设置。

## 💡 完整示例 (AI 驱动)

**1. 你的聊天消息**

```
你拔出长剑，决心面对前方的巨龙。你对身旁的伙伴喊道：“掩护我！”，然后挥动了手中的武器，发起了进攻！战斗持续了很久，最终你成功击败了巨龙，疲惫地收剑入鞘。
```

**2. 双击该消息，AI 可能生成如下方案 (此过程自动完成)**

```xml
<Music>
  [src=史诗音乐, loop=true, regex_start=/^你拔出长剑/, regex_end=/收剑入鞘/, spatial:正前方, ir_description:户外]
</Music>
<SFX>
  [src=挥剑声, regex=/挥动了手中的武器/, spatial:正前方, ir_description:户外]
</SFX>
<VOICE>
  [speaker=你的角色音色, context_texts=大声地、充满决心地喊叫, loop=false, spatial=正前方站立, ir_description:户外, regex=/"掩护我！"/]
</VOICE>
```

**3. 再次双击，效果如下**
-   阅读到“你拔出长剑”时，`史诗音乐` 开始从前方循环播放。
-   阅读到“掩护我！”时，会播放由 TTS 合成的、带有“决心地喊叫”语气的角色语音。
-   阅读到“挥动了手中的武器”时，会播放一次前方的 `挥剑声` 音效。
-   阅读到“收剑入鞘”时，`史诗音乐` 停止。

---
享受你的沉浸式阅读体验吧！

## 帮助

[飞书文档](https://gxcgf4l6b2y.feishu.cn/wiki/IS3xwfqG7ii78pkwqkkcE8donUb?from=from_copylink) | [投喂作者](https://afdian.com/a/cqgnyy)

## 许可证

- [Aladdin](LICENSE)
